name: WIRU Serverless POC (Complete Pipeline)

on:
  push:
  workflow_dispatch:
    inputs:
      app-name:
        description: 'Application name'
        required: false
        type: string
        default: 'my-app'
      stage:
        description: 'Stage: dev | stg | prod'
        required: true
        type: string
        default: 'dev'
      version:
        description: 'App version (semver, optional)'
        required: false
        type: string
        default: ''
      do-remove:
        description: 'Execute serverless remove (manual only)'
        required: false
        type: boolean
        default: false
      do-rollback:
        description: 'Execute serverless rollback (manual only)'
        required: false
        type: boolean
        default: false
      rollback-to:
        description: 'Rollback timestamp/ID (optional)'
        required: false
        type: string
        default: ''
  workflow_call:
    inputs:
      app-name:
        required: false
        type: string
        default: 'my-app'
      stage:
        required: true
        type: string
      version:
        required: false
        type: string
        default: ''

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ inputs.app-name || 'my-app' }}-${{ inputs.stage || 'dev' }}
  cancel-in-progress: false

defaults:
  run:
    shell: bash

env:
  APP_NAME: ${{ inputs.app-name || 'my-app' }}
  STAGE: ${{ inputs.stage || 'dev' }}
  INPUT_VERSION: ${{ inputs.version || '' }}

jobs:
  ##############################################################################
  # Stage 1 - Initialization
  ##############################################################################
  winit:
    name: "Installation & Setup"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Simulate init
        run: |
          echo "ğŸ§° Initializing workflow..."
          echo "APP_NAME: ${APP_NAME}"
          echo "STAGE: ${STAGE}"
          echo "VERSION: ${INPUT_VERSION}"
          echo "âœ… Workflow initialized"
          sleep 2

  ##############################################################################
  # Stage 2 - Version Validation
  ##############################################################################
  wversion:
    name: "Version Validation"
    needs: [winit]
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Validate Semver
        id: version
        run: |
          if [ -n "${INPUT_VERSION}" ]; then
            if echo "${INPUT_VERSION}" | grep -Eq '^[0-9]+\.[0-9]+\.[0-9]+([-+][A-Za-z0-9\.:-]+)?$'; then
              echo "âœ… Valid semver: ${INPUT_VERSION}"
              echo "version=${INPUT_VERSION}" >> $GITHUB_OUTPUT
            else
              echo "âŒ Invalid semver format"
              exit 1
            fi
          else
            VERSION="1.0.${GITHUB_RUN_NUMBER}"
            echo "ğŸ·ï¸  Auto-generated version: ${VERSION}"
            echo "version=${VERSION}" >> $GITHUB_OUTPUT
          fi

  ##############################################################################
  # Stage 3 - Parallel Testing
  ##############################################################################
  wtest:
    name: "Unit Tests (Node ${{ matrix.node }})"
    needs: [winit]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node: ['18', '20', '22']
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node ${{ matrix.node }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: 'npm'
      
      - name: Run Unit Tests
        run: |
          echo "ğŸ§ª Running unit tests on Node ${{ matrix.node }}..."
          # npm ci
          # npm test
          sleep 3
          echo "âœ… Tests passed on Node ${{ matrix.node }}"

  wcoverage:
    name: "Test Coverage"
    needs: [winit]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Generate Coverage
        run: |
          echo "ğŸ“Š Generating test coverage..."
          # npm ci
          # npm run test:coverage
          mkdir -p coverage
          echo "TN:" > coverage/lcov.info
          echo "SF:src/handler.ts" >> coverage/lcov.info
          echo "DA:1,1" >> coverage/lcov.info
          echo "DA:5,1" >> coverage/lcov.info
          echo "LF:2" >> coverage/lcov.info
          echo "LH:2" >> coverage/lcov.info
          echo "end_of_record" >> coverage/lcov.info
          sleep 2
          echo "âœ… Coverage: 87.5%"
      
      - name: Upload Coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/lcov.info
          retention-days: 1

  wlint:
    name: "Code Linting"
    needs: [winit]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Run Linter
        run: |
          echo "ğŸ” Running ESLint..."
          # npm ci
          # npm run lint
          sleep 2
          echo "âœ… No linting errors"

  wsca:
    name: "Security Scan (SCA)"
    needs: [winit]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Security Audit
        run: |
          echo "ğŸ”’ Running security scan..."
          # npm audit --audit-level=moderate
          sleep 2
          echo "âœ… No critical vulnerabilities"

  ##############################################################################
  # Stage 4 - Code Quality (depends on coverage)
  ##############################################################################
  wsonar:
    name: "SonarQube Analysis"
    needs: [wcoverage, wlint, wsca]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Download Coverage
        uses: actions/download-artifact@v4
        with:
          name: coverage-report
          path: coverage
        continue-on-error: true
      
      - name: SonarQube Analysis
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        run: |
          echo "ğŸ“Š Running SonarQube analysis..."
          echo "Project: ${APP_NAME}"
          sleep 3
          echo ""
          echo "Quality Gate Results:"
          echo "  âœ“ Code Coverage: 87.5%"
          echo "  âœ“ Maintainability: A"
          echo "  âœ“ Reliability: A"
          echo "  âœ“ Security: A"
          echo ""
          echo "âœ… Quality Gate PASSED"
          # sonar-scanner \
          #   -Dsonar.projectKey=${APP_NAME} \
          #   -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info

  ##############################################################################
  # Stage 5 - Serverless Deploy
  ##############################################################################
  wsls-deploy:
    name: "Serverless Deploy (${{ inputs.stage || 'dev' }})"
    needs: [wsonar, wtest, wversion]
    if: ${{ !inputs.do-remove && !inputs.do-rollback }}
    runs-on: ubuntu-latest
    environment: 
      name: ${{ inputs.stage || 'dev' }}
      url: https://${{ inputs.stage || 'dev' }}.wiru-app.com
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Configure AWS Credentials
        run: |
          echo "ğŸ” Configuring AWS credentials..."
          # Configure AWS credentials here
          echo "âœ… AWS configured"
      
      - name: Serverless Deploy
        run: |
          echo "ğŸš€ Serverless Framework - Deploying..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Environment: ${STAGE}"
          echo "Application: ${APP_NAME}"
          VERSION="${{ needs.wversion.outputs.version }}"
          echo "Version: ${VERSION}"
          echo "Region: us-east-1"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          sleep 2
          
          echo ""
          echo "Serverless: Packaging service..."
          echo "Serverless: Excluding development dependencies..."
          sleep 2
          
          echo ""
          echo "Serverless: Uploading CloudFormation file to S3..."
          echo "Serverless: Uploading artifacts..."
          echo "Serverless: Uploading service ${APP_NAME}.zip (2.3 MB)..."
          sleep 3
          
          echo ""
          echo "Serverless: Validating template..."
          echo "Serverless: Updating Stack..."
          sleep 2
          
          echo ""
          echo "CloudFormation - Stack Update Progress:"
          echo "  âœ“ AWS::Lambda::Function - ${APP_NAME}-${STAGE}-api"
          echo "  âœ“ AWS::Lambda::Function - ${APP_NAME}-${STAGE}-worker"
          echo "  âœ“ AWS::ApiGatewayV2::Api - ${APP_NAME}-${STAGE}"
          echo "  âœ“ AWS::DynamoDB::Table - ${APP_NAME}-${STAGE}-users"
          echo "  âœ“ AWS::S3::Bucket - ${APP_NAME}-${STAGE}-uploads"
          echo "  âœ“ AWS::CloudWatch::LogGroup - /aws/lambda/${APP_NAME}-${STAGE}-api"
          sleep 3
          
          echo ""
          echo "Serverless: Stack update finished..."
          echo ""
          echo "Service Information:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  service: ${APP_NAME}"
          echo "  stage: ${STAGE}"
          echo "  region: us-east-1"
          echo "  stack: ${APP_NAME}-${STAGE}"
          echo "  api endpoint: https://api-${STAGE}.wiru-app.com"
          echo ""
          echo "Functions:"
          echo "  api: ${APP_NAME}-${STAGE}-api"
          echo "  worker: ${APP_NAME}-${STAGE}-worker"
          echo ""
          echo "Endpoints:"
          echo "  ANY - https://api-${STAGE}.wiru-app.com/{proxy+}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          echo ""
          echo "âœ… Deployment completed successfully!"
          echo "ğŸŒ URL: https://${STAGE}.wiru-app.com"
          
          # Real command:
          # npm ci --production
          # serverless deploy --stage "${STAGE}" --verbose

  ##############################################################################
  # Stage 6 - Serverless Rollback (Manual)
  ##############################################################################
  wsls-rollback:
    name: "Serverless Rollback (${{ inputs.stage }})"
    needs: [wsonar, wtest]
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.do-rollback }}
    runs-on: ubuntu-latest
    environment: 
      name: ${{ inputs.stage }}-rollback
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Configure AWS Credentials
        run: |
          echo "ğŸ” Configuring AWS credentials..."
          echo "âœ… AWS configured"
      
      - name: Serverless Rollback
        run: |
          echo "âª Starting Serverless Rollback..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Environment: ${STAGE}"
          echo "Application: ${APP_NAME}"
          ROLLBACK_TO="${{ inputs.rollback-to }}"
          if [ -n "${ROLLBACK_TO}" ]; then
            echo "Rollback to: ${ROLLBACK_TO}"
          else
            echo "Rollback to: Previous deployment"
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          sleep 2
          
          echo ""
          echo "Fetching deployment history..."
          sleep 2
          echo "  â€¢ Current: 2024-01-15T10:30:45Z"
          echo "  â€¢ Previous: 2024-01-15T09:15:22Z"
          echo "  â€¢ Previous-2: 2024-01-14T16:42:10Z"
          
          echo ""
          echo "Serverless: Rolling back CloudFormation stack..."
          sleep 2
          
          echo ""
          echo "CloudFormation - Rollback Progress:"
          echo "  âœ“ Reverting Lambda function code"
          echo "  âœ“ Restoring API Gateway configuration"
          echo "  âœ“ Rolling back IAM roles"
          sleep 2
          echo "  âœ“ Restoring environment variables"
          echo "  âœ“ Reverting CloudWatch alarms"
          
          echo ""
          sleep 2
          echo "Serverless: Rollback complete"
          echo ""
          echo "âœ… Rollback completed successfully!"
          echo "âš ï¸  Please verify the application is working correctly"
          
          # Real command:
          # npm ci
          # if [ -n "${ROLLBACK_TO}" ]; then
          #   serverless rollback --timestamp "${ROLLBACK_TO}" --stage "${STAGE}"
          # else
          #   serverless rollback --stage "${STAGE}"
          # fi
      
      - name: Verify Rollback
        run: |
          echo ""
          echo "ğŸ” Verifying rollback..."
          sleep 2
          echo "  âœ“ Lambda functions responding"
          echo "  âœ“ API Gateway accessible"
          echo "  âœ“ DynamoDB accessible"
          echo ""
          echo "âœ… Rollback verification passed"
      
      - name: Notify Rollback
        run: |
          echo ""
          echo "ğŸ“¢ Rollback notifications:"
          echo "  â€¢ Slack: #deployments"
          echo "  â€¢ Email: devops-team@wiru.com"
          echo "  â€¢ PagerDuty: Incident logged"

  ##############################################################################
  # Stage 7 - Serverless Remove (Manual)
  ##############################################################################
  wsls-remove:
    name: "Serverless Remove (${{ inputs.stage }})"
    needs: [wsonar, wtest]
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.do-remove }}
    runs-on: ubuntu-latest
    environment: 
      name: ${{ inputs.stage }}-remove
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Configure AWS Credentials
        run: |
          echo "ğŸ” Configuring AWS credentials..."
          echo "âœ… AWS configured"
      
      - name: Serverless Remove
        run: |
          echo "ğŸ—‘ï¸  Starting Serverless Remove..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âš ï¸  WARNING: This will delete all resources!"
          echo "Environment: ${STAGE}"
          echo "Application: ${APP_NAME}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          sleep 3
          
          echo ""
          echo "Serverless: Removing service..."
          sleep 2
          
          echo ""
          echo "CloudFormation - Deletion Progress:"
          echo "  âœ“ Deleting Lambda functions"
          echo "  âœ“ Deleting API Gateway"
          sleep 2
          echo "  âœ“ Deleting DynamoDB tables"
          echo "  âœ“ Deleting S3 buckets"
          echo "  âœ“ Deleting CloudWatch logs"
          sleep 2
          echo "  âœ“ Deleting IAM roles"
          echo "  âœ“ Removing CloudFormation stack"
          
          echo ""
          sleep 2
          echo "Serverless: Service removed"
          echo ""
          echo "âœ… All resources have been removed"
          
          # Real command:
          # npm ci
          # serverless remove --stage "${STAGE}" --verbose
      
      - name: Verify Removal
        run: |
          echo ""
          echo "ğŸ” Verifying removal..."
          sleep 2
          echo "  âœ“ CloudFormation stack: DELETED"
          echo "  âœ“ Lambda functions: DELETED"
          echo "  âœ“ API Gateway: DELETED"
          echo ""
          echo "âœ… Removal verification passed"
      
      - name: Notify Removal
        run: |
          echo ""
          echo "ğŸ“¢ Removal notifications:"
          echo "  â€¢ Slack: #deployments"
          echo "  â€¢ Email: devops-team@wiru.com"
          echo "  âš ï¸  Environment ${STAGE} has been completely removed"

  ##############################################################################
  # Stage 8 - Notifications
  ##############################################################################
  wnotify:
    name: "Send Notifications"
    needs: [wsls-deploy]
    if: always() && !inputs.do-remove && !inputs.do-rollback
    runs-on: ubuntu-latest
    steps:
      - name: Deployment Summary
        run: |
          echo "================================================"
          echo "      WIRU SERVERLESS DEPLOYMENT SUMMARY"
          echo "================================================"
          echo ""
          echo "Pipeline ID: ${{ github.run_id }}"
          echo "Commit: ${GITHUB_SHA:0:8}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Triggered by: ${{ github.actor }}"
          echo "Environment: ${STAGE}"
          echo ""
          echo "âœ… Deployment completed"
          echo "ğŸŒ URL: https://${STAGE}.wiru-app.com"
          echo ""
      
      - name: Notify Success
        if: ${{ needs.wsls-deploy.result == 'success' }}
        run: |
          echo "âœ… DEPLOYMENT SUCCESSFUL!"
          echo ""
          echo "ğŸ“¢ Notifications sent to:"
          echo "  â€¢ Slack: #deployments"
          echo "  â€¢ Email: devops-team@wiru.com"
      
      - name: Notify Failure
        if: ${{ needs.wsls-deploy.result == 'failure' }}
        run: |
          echo "âŒ DEPLOYMENT FAILED!"
          echo ""
          echo "ğŸš¨ Notifications sent to:"
          echo "  â€¢ Slack: #incidents"
          echo "  â€¢ Email: devops-team@wiru.com"
