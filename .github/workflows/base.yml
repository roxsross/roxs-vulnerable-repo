name: WIRU Serverless POC (matrix tests + sonar, clean flow)

on:
  push:
  workflow_dispatch:
permissions:
  contents: read

env:
  APP_NAME: ${{ github.event.inputs.app-name || 'my-app' }}
  STAGE: ${{ github.event.inputs.stage || 'dev' }}
  INPUT_VERSION: ${{ github.event.inputs.version || '' }}

jobs:
  init:
    name: "winstall"
    runs-on: ubuntu-latest
    steps:
      - name: Simulate init
        run: |
          echo "ðŸ§° Initializing workflow..."
          echo "APP_NAME: ${APP_NAME}"
          echo "STAGE: ${STAGE}"
          echo "VERSION: ${INPUT_VERSION}"

  wtest:
    needs: init
    runs-on: ubuntu-latest
    outputs:
      test_status: ${{ steps.test.outcome }}
    strategy:
      matrix: { target: [wtest, wsonar] }
    steps:
      - uses: actions/checkout@v5
      - name: Setup Node
        if: matrix.target == 'wtest' || matrix.target == 'wsonar'
        uses: actions/setup-node@v4
        with: { node-version: '20' }
      
      - name: Unit Tests
        id: test
        if: matrix.target == 'wtest'
        run: echo "UNIT TESTS"
      
      - name: Wait for wtest
        if: matrix.target == 'wsonar'
        run: |
          # Esto NO funciona porque los jobs de matriz son independientes
          echo "Cannot wait for parallel job"
      
      - name: SonarQube
        if: matrix.target == 'wsonar'
        run: echo "SONAR"

