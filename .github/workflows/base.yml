name: WIRU Serverless POC

on:
  push:
  workflow_call:
    inputs:
      app-name:
        description: 'Application name'
        required: false
        type: string
        default: 'my-app'
      stage:
        description: 'Stage: dev | stg'
        required: true
        type: string
      version:
        description: 'App version (semver, opcional)'
        required: false
        type: string
        default: ''
      do-remove:
        description: 'Execute serverless remove'
        required: false
        type: boolean
        default: false
      do-rollback:
        description: 'Execute serverless rollback'
        required: false
        type: boolean
        default: false
      rollback-to:
        description: 'Rollback timestamp/ID (optional)'
        required: false
        type: string
        default: ''

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ inputs.app-name }}-${{ inputs.stage }}
  cancel-in-progress: false

env:
  APP_NAME: ${{ inputs.app-name }}
  STAGE: ${{ inputs.stage }}

jobs:
  # === init ===
  init:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: install dependencies
        run: |
          echo "=========================================="
          echo "üöÄ INIT ‚Äì install dependencies"
          echo "=========================================="
          if [ -f "package.json" ]; then
            npm ci --silent || true
          fi
          npm i -g serverless >/dev/null 2>&1 || true
          echo "‚úÖ Entorno listo"

  # === check (solo Version Checks) ===
  check-version:
    needs: init
    runs-on: ubuntu-latest
    steps:
      - name: Version Checks (semver)
        run: |
          echo "=========================================="
          echo "üîç CHECK ‚Äì Version Checks"
          echo "=========================================="
          echo "Stage: ${STAGE}"
          if [ "${STAGE}" = "prod" ]; then
            echo "‚ùå Deploy a PROD no permitido en esta POC"
            exit 1
          fi
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
            if echo "$VERSION" | grep -Eq '^[0-9]+\.[0-9]+\.[0-9]+([\-+][A-Za-z0-9\.-]+)?$'; then
              echo "‚úÖ Versi√≥n v√°lida: $VERSION"
            else
              echo "‚ùå Versi√≥n inv√°lida (use semver, ej: 1.2.3)"
              exit 1
            fi
          else
            echo "‚ÑπÔ∏è Sin versi√≥n provista, continuo‚Ä¶"
          fi
          echo "‚úÖ Checks OK"

  # === test ===
  test:
    needs: check-version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Wiru TestJs
        run: |
          echo "=========================================="
          echo "üß™ TEST ‚Äì Wiru TestJs"
          echo "=========================================="
          if [ -f "package.json" ]; then
            npm test --silent || echo "‚ÑπÔ∏è Tests no configurados, continuo‚Ä¶"
          else
            echo "‚ÑπÔ∏è No se detect√≥ Node; smoke test"
            echo "ok"
          fi
          echo "‚úÖ Tests completados"

  # === deploy (serverless) ===
  deploy:
    needs: test
    if: ${{ !inputs.do-remove && !inputs.do-rollback }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.stage }}
    steps:
      - uses: actions/checkout@v4
      - name: Deploy Serverless
        run: |
          echo "=========================================="
          echo "üöÄ DEPLOY ‚Äì Serverless (${STAGE})"
          echo "=========================================="
          echo "App: ${APP_NAME}"
          # Ejemplo:
          # serverless deploy --stage ${STAGE}
          echo "üåê URL (ejemplo): https://${STAGE}.example.com/${APP_NAME}"
          echo "‚úÖ Deploy ${STAGE} OK"

  # === remove (serverless) ===
  remove:
    needs: test
    if: ${{ inputs.do-remove }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.stage }}
    steps:
      - uses: actions/checkout@v4
      - name: Remove Serverless
        run: |
          echo "=========================================="
          echo "üßπ REMOVE ‚Äì Serverless (${STAGE})"
          echo "=========================================="
          # Ejemplo:
          # serverless remove --stage ${STAGE}
          echo "‚úÖ Remove ${STAGE} OK"

  # === rollback (serverless) ===
  rollback:
    needs: test
    if: ${{ inputs.do-rollback }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.stage }}
    steps:
      - uses: actions/checkout@v4
      - name: Rollback Serverless
        run: |
          echo "=========================================="
          echo "üõ°Ô∏è  ROLLBACK ‚Äì Serverless (${STAGE})"
          echo "=========================================="
          RB_TO="${{ inputs.rollback-to }}"
          if [ -n "${RB_TO}" ]; then
            echo "‚è™ Rollback a: ${RB_TO}"
            # Ejemplo:
            # serverless rollback --stage ${STAGE} --timestamp ${RB_TO}
          else
            echo "‚è™ Rollback al √∫ltimo deployment (placeholder)"
            # Ejemplo:
            # serverless rollback --stage ${STAGE}
          fi
          echo "‚úÖ Rollback ${STAGE} OK"

  # === summary ===
  summary:
    needs: [deploy, remove, rollback]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Resumen
        run: |
          echo "=========================================="
          echo "üìä RESUMEN FINAL"
          echo "=========================================="
          echo "üì¶ App: ${APP_NAME}"
          echo "üåç Stage: ${STAGE}"
          echo "üè∑Ô∏è Versi√≥n: ${{ inputs.version || 'n/a' }}"
          echo "üßπ Remove:  ${{ inputs.do-remove }}"
          echo "‚è™ Rollback: ${{ inputs.do-rollback }}"
          echo "‚è∞ $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          echo "=========================================="
