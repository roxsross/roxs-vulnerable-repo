name: WIRU Serverless POC (matrix tests + sonar, clean flow)

on:
  push:
  workflow_dispatch:
  workflow_call:
    inputs:
      app-name:
        description: 'Application name'
        required: false
        type: string
        default: 'my-app'
      stage:
        description: 'Stage: dev | stg'
        required: true
        type: string
      version:
        description: 'App version (semver, optional)'
        required: false
        type: string
        default: ''
      do-remove:
        description: 'Execute serverless remove (manual only)'
        required: false
        type: boolean
        default: false
      do-rollback:
        description: 'Execute serverless rollback (manual only)'
        required: false
        type: boolean
        default: false
      rollback-to:
        description: 'Rollback timestamp/ID (optional)'
        required: false
        type: string
        default: ''

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.event.inputs.app-name || 'default' }}-${{ github.event.inputs.stage || 'dev' }}
  cancel-in-progress: false

defaults:
  run:
    shell: bash

env:
  APP_NAME: ${{ github.event.inputs.app-name || 'my-app' }}
  STAGE: ${{ github.event.inputs.stage || 'dev' }}
  INPUT_VERSION: ${{ github.event.inputs.version || '' }}

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  wiru_init:
    name: "ğŸ§° init"
    runs-on: ubuntu-latest
    steps:
      - name: Simulate init
        run: |
          echo "ğŸ§° Initializing workflow..."
          echo "APP_NAME: ${APP_NAME}"
          echo "STAGE: ${STAGE}"
          echo "VERSION: ${INPUT_VERSION}"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ VERSION CHECK (dep INIT) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  wiru_versioncheck:
    name: "ğŸ·ï¸ version-check"
    needs: wiru_init
    runs-on: ubuntu-latest
    steps:
      - name: Validate semver (optional)
        run: |
          echo "ğŸ·ï¸ Checking version..."
          VERSION="${INPUT_VERSION}"
          if [ -n "${VERSION}" ]; then
            if echo "${VERSION}" | grep -Eq '^[0-9]+\.[0-9]+\.[0-9]+([-+][A-Za-z0-9\.:-]+)?$'; then
              echo "âœ… Version ok: ${VERSION}"
            else
              echo "âŒ Invalid semver (use 1.2.3 or 1.2.3-alpha.1)"
              exit 1
            fi
          else
            echo "â„¹ï¸ No version provided; continuing"
          fi

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ UNIT TESTS (MATRIX) dep INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  wtest_unit:
    name: "ğŸ§ª unit-test (node ${{ matrix.node }})"
    needs: wiru_init
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node: [20]
    steps:
      - name: Simulate unit tests
        run: |
          echo "ğŸ§ª Running unit tests on Node ${{ matrix.node }}..."
          echo "Installing dependencies..."
          echo "Running tests with coverage..."
          echo "âœ… Tests passed!"
          echo "ğŸ“Š Coverage generated"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SONAR (MATRIX) dep UNIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  wtest_sonar:
    name: "ğŸ“Š sonar (${{ matrix.scanner }})"
    needs: wtest_unit
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        scanner: [sonarqube]
    steps:
      - name: Simulate Sonar analysis
        run: |
          echo "ğŸ“Š Running Sonar analysis (${{ matrix.scanner }})..."
          echo "Downloading Sonar Scanner..."
          echo "Analyzing code quality..."
          echo "Uploading results to SonarQube..."
          echo "âœ… Sonar analysis complete!"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ DEPLOY dep SONAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  wdeploy_deploy:
    name: "ğŸš€ deploy to ${{ github.event.inputs.stage || 'dev' }}"
    needs: wtest_sonar
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.stage || 'dev' }}
    steps:
      - name: Simulate deployment
        run: |
          echo "ğŸš€ Deploying ${APP_NAME} to ${STAGE}..."
          echo "serverless deploy --stage ${STAGE}"
          echo "âœ… Deployment complete!"
          echo "ğŸŒ URL: https://${STAGE}.example.com/${APP_NAME}"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ REMOVE (manual) dep SONAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  wdeploy_remove:
    name: "ğŸ§¹ remove from ${{ github.event.inputs.stage }}"
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.do-remove == 'true'
    needs: wtest_sonar
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.stage }}
    steps:
      - name: Simulate removal
        run: |
          echo "ğŸ§¹ Removing ${APP_NAME} from ${STAGE}..."
          echo "serverless remove --stage ${STAGE}"
          echo "âœ… Stack removed successfully"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ROLLBACK (manual) dep SONAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  wdeploy_rollback:
    name: "âª rollback on ${{ github.event.inputs.stage }}"
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.do-rollback == 'true'
    needs: wtest_sonar
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.stage }}
    steps:
      - name: Simulate rollback
        run: |
          echo "âª Rolling back ${APP_NAME} on ${STAGE}..."
          RB_TO="${{ github.event.inputs.rollback-to }}"
          if [ -n "${RB_TO}" ]; then
            echo "ğŸ“ Rollback to: ${RB_TO}"
            echo "serverless rollback --stage ${STAGE} --timestamp ${RB_TO}"
          else
            echo "ğŸ“ Rollback to last deployment"
            echo "serverless rollback --stage ${STAGE}"
          fi
          echo "âœ… Rollback complete"
