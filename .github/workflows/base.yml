name: WIRU Serverless POC (matrix tests + sonar, clean flow)
on:
  push:
  workflow_dispatch:
permissions:
  contents: read
defaults:
  run:
    shell: bash
env:
  APP_NAME: ${{ github.event.inputs.app-name || 'my-app' }}
  STAGE: ${{ github.event.inputs.stage || 'dev' }}
  INPUT_VERSION: ${{ github.event.inputs.version || '' }}
  
jobs:
  init:
    name: "winstall"
    runs-on: ubuntu-latest
    steps:
      - name: Simulate init
        run: |
          echo "ðŸ§° Initializing workflow..."
          echo "APP_NAME: ${APP_NAME}"
          echo "STAGE: ${STAGE}"
          echo "VERSION: ${INPUT_VERSION}"
  
  wtest:
    name: "Unit Tests"
    needs: init
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with: { node-version: '20' }
      
      - name: Run Tests
        run: |
          echo "ðŸ§ª Running unit tests..."
          # npm test
          # npm run test:coverage
      
      - name: Upload Coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 1
  
  wsonar:
    name: "SonarQube Analysis"
    needs: wtest  # ðŸ‘ˆ Espera a que los tests terminen
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Necesario para SonarQube
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with: { node-version: '20' }
      
      - name: Download Coverage
        uses: actions/download-artifact@v4
        with:
          name: coverage-report
          path: coverage/
      
      - name: SonarQube Analysis
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        run: |
          echo "ðŸ“Š Running SonarQube analysis..."
          # sonar-scanner \
          #   -Dsonar.projectKey=my-project \
          #   -Dsonar.sources=src \
          #   -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
